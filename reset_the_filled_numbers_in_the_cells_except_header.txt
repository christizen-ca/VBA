Sub change_each_form_to_value()
'마지막에 거래가 추가되면 추가된 부가세, 전잔, 현잔 수식을 값으로 변경하는 별도의 함수
'기존 함수에서 수정은 최종 거래 추가된 것이 제대로 인식이 안되서 별도 함수로 구현 처리

'화면 업데이트 비활성화 설정 (성능 개선 코드)
Application.ScreenUpdating = False
'수식 계산 옵션 수동 설정(성능 개선 코드)
Application.Calculation = xlCalculationManual


'거래내역이 추가되고 나서 거래명세전체 시트로 이동을 해서 처리하는 과정이기 때문에 현재 시트에 대한 변수 할당이 필요함
Dim current_sheet As Worksheet
Set current_sheet = ActiveSheet '현재 활성화된 시트를 변수로 할당

Dim x As Worksheet
Set x = Worksheets("#거래명세전체")    '실행시트명 할당 ☆★☆★☆★☆★
    
'☆★☆★배열의 값을 시트에 복사하기 위해 해당 시트를 다시 활성화
x.Activate
    
'거래내역이 추가되면서 수식으로 복사된 전잔, 현잔, 부가세를 다시 값으로 변환(최종값이 추가된 후 한번 더 마지막 값을 찾아서 진행해야 함.)
'마지막 거래내역의 전잔을 변수에 할당
Dim lastcell_M
lastcell_M = Cells(Rows.Count, "M").End(xlUp).Row

'마지막 행을 복사한 후 수식을 값으로 변환(스스로 셀을 수식에서 값으로 변환하는 과정)
Range("m" & lastcell_M).Copy
Range("m" & lastcell_M).PasteSpecial xlPasteValues

'마지막 거래내역의 부가세를 변수에 할당
Dim lastcell_J
lastcell_J = Cells(Rows.Count, "J").End(xlUp).Row

'마지막 행을 복사한 후 수식을 값으로 변환(스스로 셀을 수식에서 값으로 변환하는 과정)
Range("j" & lastcell_J).Copy
Range("j" & lastcell_J).PasteSpecial xlPasteValues

'마지막 거래내역의 현잔을 변수에 할당
Dim lastcell_N
lastcell_N = Cells(Rows.Count, "N").End(xlUp).Row

'가장 마지막 행을 복사한 후 값으로 복사해서 수식을 값으로 변환
Range("n" & lastcell_N).Copy
Range("n" & lastcell_N).PasteSpecial xlPasteValues

'적요 생성 중인 시트를 다시 활성화(수식을 값으로 변경하기 위해 다른 시트 이동한 것을 다시 원상복구 시키는 코드)
current_sheet.Activate

 '변수 초기화
Set x = Nothing
Set current_sheet = Nothing
   
'화면 업데이트 활성화 설정 (성능 개선 코드)
Application.ScreenUpdating = True
'수식 계산 옵션 자동 설정 복원 (성능 개선 코드)
Application.Calculation = xlCalculationAutomatic

End Sub
Sub refresh_formulas_in_entire_sheet()

'전체 필터 해제
Dim w As Worksheet
Set w = Worksheets("#거래명세전체")

'복사할 시트의 필터가 걸려있다면 필터 해제
If (w.AutoFilterMode And w.FilterMode) Or w.FilterMode Then
    w.ShowAllData
End If


'전잔, 현잔, 부가세 함수 자동으로 갱신하고, 값으로 대체하는 함수

'전잔갱신
'가장 마지막 전잔을 찾아 행번호를 저장하기 위한 변수
Dim lastcell_M

'M열의 가장 마지막 행번호를 찾아서 lastcell_M에 값으로 할당
lastcell_M = Cells(Rows.Count, "M").End(xlUp).Row

'마지막 거래내역의 전잔 수식을 모두 복사하여 전체 전잔 수식을 갱신 (전잔 계산을 위해 m6셀 부터 수식이 시작됨)
'Range("m" & lastcell_M).Copy
'Range("m" & 6 & ":m" & lastcell_M - 1).PasteSpecial

'초기 거래내역의 전잔 수식을 모두 복사하여 전체 전잔 수식을 갱신 (전잔 계산을 위해 m7셀 부터 수식이 시작됨) (변경)
'초기 수식을 복사해서 가장 마지막 행까지 수식을 복사 갱신 (m7이 실제 시작 행임에 유의)
Range("m6").Copy
Range("m" & 7 & ":m" & lastcell_M).PasteSpecial

'마지막 거래로부터 최근 500개 거래건까지 수식을 남기고 이전 거래건은 모두 값으로 대체)
'Range("m" & 7 & ":m" & lastcell_M - 500).Copy
'Range("m" & 7 & ":m" & lastcell_M - 500).PasteSpecial xlPasteValues

'전체 거래건을 모두 값으로 대체
Range("m" & 7 & ":m" & lastcell_M).Copy
Range("m" & 7 & ":m" & lastcell_M).PasteSpecial xlPasteValues

'현잔갱신
'가장 마지막 현잔을 찾아 행번호를 저장하기 위한 변수
Dim lastcell_N

'N열의 가장 마지막 행번호를 찾아서 lastcell_N에 값으로 할당
lastcell_N = Cells(Rows.Count, "N").End(xlUp).Row

'마지막 거래내역의 현잔 수식을 모두 복사하여 전체 현잔 수식을 갱신 (현잔 계산을 위해 n6셀 부터 수식이 시작됨)
'Range("n" & lastcell_N).Copy
'Range("n" & 6 & ":n" & lastcell_N - 1).PasteSpecial

'초기 거래내역의 현잔 수식을 모두 복사하여 전체 전잔 수식을 갱신 (전잔 계산을 위해 n7셀 부터 수식이 시작됨) (변경)
'초기 수식을 복사해서 가장 마지막 행까지 수식을 복사 갱신 (n7이 실제 시작 행임에 유의)
Range("n6").Copy
Range("n" & 7 & ":n" & lastcell_N).PasteSpecial

'마지막 거래로부터 최근 500개 거래건까지 수식을 남기고 이전 거래건은 모두 값으로 대체)
Range("n" & 7 & ":n" & lastcell_N).Copy
Range("n" & 7 & ":n" & lastcell_N).PasteSpecial xlPasteValues

'부가세 갱신
'가장 마지막 부가세를 찾아 행번호를 저장하기 위한 변수
'☆★0이 아닌 값들에 대해서만 수식을 갱신해주고, 값이 0인 경우 부가세 함수를 갱신처리하지 않도록 수정
'Dim lastcell_J
'Dim varC
'
'Dim k As Long
'
'varC = Range("H7", Cells(Rows.Count, "J").End(3))
'
'For k = 1 To UBound(varC, 1)               '1 ~ varC 배열 상한값까지 반복
'            If IsNull(varC(k, 1)) = True Then     '배열내 두 값이 일치하면
'
'                MsgBox "거래액이 입력되지 않은 거래내역이 존재합니다. 거래액이 없을 경우 0원을 입력해야 됩니다."
'
'            ElseIf varC(k, 1) = 0 Then
'
'
'            Else
'
'                Range("j6").Copy
'
'                Range("j" & k + 6).PasteSpecial        '☆★varA열의 오른쪽 오른쪽에 일치한 값 입력 (일치하는 값으로부터 오른쪽으로 두칸 건너 있는 값)
'
'                Exit For                           'For 구문 종료
'            End If
'        Next k

'
'
''N열의 가장 마지막 행번호를 찾아서 lastcell_N에 값으로 할당
'lastcell_J = Cells(Rows.Count, "J").End(xlUp).Row
'
''마지막 거래내역의 현잔 수식을 모두 복사하여 전체 현잔 수식을 갱신 (현잔 계산을 위해 n6셀 부터 수식이 시작됨)
'Range("j6").Copy
'
'For k = 7 To lastcell_J
'
'    If IsNull(Range("h" & k).Value) Then
'        MsgBox "거래액이 입력되지 않은 거래내역이 존재합니다. 거래액이 없을 경우 0원을 입력해야 됩니다."
'
'    Else
'        Range("j" & k).PasteSpecial
'    End If
'
'Next k

lastcell_J = Cells(Rows.Count, "J").End(xlUp).Row

Range("j6").Copy
Range("j" & 7 & ":j" & lastcell_J).PasteSpecial

'마지막 거래로부터 최근 500개 거래건까지 수식을 남기고 이전 거래건은 모두 값으로 대체)
Range("j" & 7 & ":j" & lastcell_J).Copy
Range("j" & 7 & ":j" & lastcell_J).PasteSpecial xlPasteValues

Application.CutCopyMode = False '카피 영역 취소

End Sub
